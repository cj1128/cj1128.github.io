---
layout: post
title: "Mac编译安装bochs"
tags: osx bochs 
---

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-

**2014-2-8号重新编辑**

**上次编译的时候只编译了一个版本,也就是`gdb-stub`版本,这次附带说明一下`inner-debug`版本怎么编译.**

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-


上次无意中在群里看到了下个学期的课表.其中有一门课我很感兴趣,那就是**操作系统原理**.很早之前就想研究操作系统了.无奈这个东西太过复杂,而且我也不知道怎么入门.一直放着没管.既然下个学期要学(虽然我完全不指望从课堂上可以学到什么东西),那我就趁着寒假好好研究一下.

知乎上有个关于操作系统的答案很有参考意义:[写一个操作系统内核有多难？大概的内容、步骤是什么？](http://www.zhihu.com/question/22463820).第一个答案建议写自己的内核之前先看看别人怎么写的.推荐看一本*linux内核完全剖析*(这个书有两个版本,一个叫*linux内核完全注释*,基于linux0.11,另一个便是这本书,基于linux0.12).动手之前参看别人的成果是我一贯坚持的学习方式,无论做什么,先看看别人的成功案例,总是没有错的.以来可以增长见识,而来也让自己动手起来更有信心.



这么一本大部头的书,从图书馆借肯定是不现实的,因为要长期攻坚.果断从亚马逊买了过来(比京东便宜).到目前为止书没有看多少,因为看起来实在是有点痛苦,涉及到很多硬件的知识和内核级别的术语,理解起来颇费力气.

既然要玩操作系统,一个好的模拟工具是必不可少的.书中推荐的工具是bochs,当然,大家都推荐bochs.然后我就开始了艰苦卓绝的安装bochs的过程.

google到的安装资料非常少.只有一两篇非常不靠谱的chinese的博客.没办法,我只好参考他了.

因为bochs的图形化需要X11.所以首先需要安装X11.mac上的X11由XQuartz项目提供.google搜索,直接去下载XQuartz的dmg包.安装即可.

然后去bochs官网下载源码包`bochs-2.6.2.tar.gz`.解压,进入目录.因为这个软件是用c++写的.跨平台很容易,源码目录中包含了很多的针对不同平台的配置文件.打开针对macosx平台的配置文件`.conf.macosx`.

**gdb-stub版本:**

```
#!/bin/sh

# this sets up the compile for MacOS X
#
# To support plugins on macosx, you must have "dlcompat" installed.  You can
# get dlcompat by installing the fink package "dlcompat-devel".  On the SF
# compile farm, dlcompat is in /sw/include and /sw/lib, so we have added
# those paths to the environment variables.

set echo
CFLAGS="-arch i386 -m32 -pipe -O3 -fomit-frame-pointer -finline-functions -falign-loops=16 -falign-jumps=16 -falign-functions=16 -falign-labels=16 -falign-loops-max-skip=15 -falign-jumps-max-skip=15 -fprefetch-loop-arrays $CFLAGS"
CPATH=""
CPPFLAGS=""
CXXFLAGS="$CFLAGS"
LDFLAGS="-arch i386 -m32 -L/opt/X11/lib"
CXX="g++ -arch i386 -m32 -L/opt/X11/lib"

export CFLAGS
export CPATH
export CPPFLAGS
export CXXFLAGS
export LDFLAGS
export CXX

./configure --enable-sb16 \
	    --enable-ne2000 \
	    --enable-all-optimizations \
            --enable-cpu-level=6 \
            --enable-x86-64 \
            --enable-vmx=2 \
            --enable-pci \
            --enable-clgd54xx \
            --enable-voodoo \
            --enable-usb \
            --enable-usb-ohci \
            --enable-usb-xhci \
            --enable-es1370 \
            --enable-e1000 \
	    --enable-plugins \
          --with-x11 \
          --enable-gdb-stub \
	    ${CONFIGURE_ARGS}
```


**inner-debug版本:**

```
#!/bin/sh

# this sets up the compile for MacOS X
#
# To support plugins on macosx, you must have "dlcompat" installed.  You can
# get dlcompat by installing the fink package "dlcompat-devel".  On the SF
# compile farm, dlcompat is in /sw/include and /sw/lib, so we have added
# those paths to the environment variables.

set echo
CFLAGS="-arch i386 -m32 -pipe -O3 -fomit-frame-pointer -finline-functions -falign-loops=16 -falign-jumps=16 -falign-functions=16 -falign-labels=16 -falign-loops-max-skip=15 -falign-jumps-max-skip=15 -fprefetch-loop-arrays $CFLAGS"
CPATH=""
CPPFLAGS=""
CXXFLAGS="$CFLAGS"
LDFLAGS="-arch i386 -m32 -L/opt/X11/lib"
CXX="g++ -arch i386 -m32 -L/opt/X11/lib"

export CFLAGS
export CPATH
export CPPFLAGS
export CXXFLAGS
export LDFLAGS
export CXX

./configure --enable-sb16 \
	    --enable-ne2000 \
	    --enable-all-optimizations \
            --enable-cpu-level=6 \
            --enable-x86-64 \
            --enable-vmx=2 \
            --enable-pci \
            --enable-clgd54xx \
            --enable-voodoo \
            --enable-usb \
            --enable-usb-ohci \
            --enable-usb-xhci \
            --enable-es1370 \
            --enable-e1000 \
	    --enable-plugins \
          --with-x11 \
          --enable-debugger \
          --enable-disasm \
          --disable-debugger-gui \
	    ${CONFIGURE_ARGS}
```

**说明几个问题:**

- 如果make不成功,提示找不到symbol,执行`make all-clean`再试
- `inner-debug`版本中,一定要加上`disable-debugger-gui`这个选项,否则会需要`gtk+`这个库,挺麻烦的.
- 两个版本均附带调试功能,gdb版本需要利用gdb连接,inner版本直接即可调试,相比之下,inner版本更加方便.
- 当然,推荐编译一个不带调试功能的版本.删掉调试选项即可(`enable-debugger`,`enable-disasm`,`enable-gdb-stub`)
- 利用`--prefix=DIR`可以更改安装目录,默认安装在`/usr/local/bin`里面.



关于这个配置文件,一部分是网络上参考的,一部分是自己摸索的.这个过程十分痛苦,每次`make`失败都不知道怎么回事,只能自己根据出错信息乱改.这个配置文件让我感觉最怪异的是`LDFLAGS="-arch i386 -m32 -L/sw/lib`,后来编译的时候提示没有`/sw/lib`这个目录,我看了一下,确实没有,非常奇怪.我不知道是怎么回事....然后我猜测可能是需要X11的库,因为X11被安装在了`/opt/X11`,所以自己改了路径.然后编译的时候g++提示找不到库,所以有把这个路径加在了g++里面.

谢天谢地,然后`make`成功了.我实在经历了太多的make失败.

最后执行`make install`安装即可.

怎么用他又花了一番精力.本打算昨天写这篇文章,结果一想,我先把他用成功再写..然后就折腾到了今天.

bochs使用时需要需要加载一个配置文件,指定虚拟机的各项配置.我按照书中所说的那样,从oldlinux上面下载了`linux-0.12-040304-snap.zip `.([地址](http://oldlinux.org/Linux.old/bochs-images/)).解压打开,里面有两个配置文件,一个为fd的,一个为hd的.

我按照提示执行`bochs -f bochsrc-0.12-fd.bxrc`.然后就华丽丽的失败了..失败信息我没有仔细看,也看不懂...当时我就慌了,以为是自己bochs安装的不够完整..于是我开始了各种重装bochs.依旧没用.

这里需要稍微说一下关于PD装ubuntu的事情.我在盗版PD8 上面试装了一次ubuntu.结果卡到不行.我以为是性能的原因,没有深究就算了.后来想想不对劲,google了一下,结果发现是PD tools没有装.正好我又觉得PD这么重要的软件我老是用盗版不好意思.所以从官网下了PD9,准备买正版了.PD9装上ubuntu以后,操作十分流畅!!!跟native差不了多少..(估计自动装上了PD tools)

然后我就开始在ubuntu上面折腾bochs...

先是安装各种依赖:

```
sudo apt-get install g++
sudo apt-get install build-essential
sudo apt-get install xorg-dev
sudo apt-get install libgtk2.0-dev
sudo apt-get install bison
```

然后同样是下载源码包,解压,进入目录:

```
./configure --enable-plugins --enable-debugger --enable-disasm
make
```

make成功了,我以为没事了,因为只剩下最后一个步骤了``` sudo make install ```,我擦,这个竟然失败了....

我表示不能理解.

算了.我又回到了mac..然后仔细看了一下linux-0.12的bochs配置文件以及出错提示信息,好吧,他说`vga_update_interval`这个东东错了..然后正好配置文件里面有个这个选项,注释掉这个选项,,然后就行了..简直感动死了...

如果用fd来启动的话,需要还盘,点击盘符没办法换,只能点击X11上面的configure来话.如果用hd来启动的话,就不用了.(这个登录shell还有密码..尼玛简直玩我..)

至此总算把工具搞好了.





