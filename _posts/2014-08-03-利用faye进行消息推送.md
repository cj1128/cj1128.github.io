---
title: 利用faye进行消息推送
tags: ruby faye 
---

消息推送一直是我非常感兴趣的领域,也是非常模糊的一个领域.感兴趣是以为这个东西很好玩也很实用,模糊是因为我对他的具体作用机理非常不清楚.因为我对网络协议不清楚.
 
Faye是一个基于rack的推送方案.上次花了点时间把他跑起来了.这次想起来写篇博客记录一下.

首先要说明的是,Faye的官网文档对新手很不友好,只说了Faye的配置,完全没说怎样把他运行起来呀...还好RailsCasts有一节视频专门讲Faye(还是免费得!),我才照着弄把他跑起来,后面就好自己摸索了.[视频地址](http://railscasts.com/episodes/260-messaging-with-faye)


接下来讲述怎样实现Faye最基本的功能,即网页能够接受到消息的推送.

首先要将Faye运行起来,因为Faye是基于rack的,先写一个rack文件:

```ruby
#faye.ru
require "faye"
server=Faye::RackAdapter.new(mount:"/faye",timeout:30)
run server
```
然后启动服务器运行Faye,

```bash
rackup -s thin -E production
```

**需要注意的几个问题**

- 首先需要安装thin,但是要让rack知道,所以得新建一个Gemfile,里面包含内容`gem 'thin'`,这样rack启动时会自动require thin 这个gem,否则就是loadError.注意faye无法工作在WEBrick下面.

- -E production这个参数一定不能少,否则会出现`Rack::Lint::LintError: Status must be >=100`这个error.主要原因是因为rack的develpment模式的中间层会与thin的async机制冲突.详见这个[issue](https://github.com/faye/faye/issues/25)**

这样faye就默认启动在localhost:9292上面了.访问*http://localhost:9292/faye.js* ,可以得到前端使用的js文件.

接下来就是写一个html文件来监听请求即可.

```html
#index.html
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Faye test</title>
</head>
<body>

</body>

<script src="http://ls:9292/faye.js"></script>
<script>
	var faye=new Faye.Client('http://ls:9292/faye');
	faye.subscribe("/messages/new",function(data){
		alert(data);
	})
</script>
</html>
```

这个文件先拿到faye.js这个一个客户端使用的js文件,然后创建客户端监听就可以了.代码很容易明白.

接下来就是怎样向服务器发送消息并且观察推送是否成功.

```bash
curl localhost:9292/faye -d 'message={"channel":"/messages/new","data":"hello world!"}'
```

也就是向服务器发送一个post请求并附带你需要推送的消息参数即可.

接着就会看到浏览器页面弹出一个提示框'hello world!'.

至此基本上就大功告成了.

这只是非常基本的应用,faye还提供很多高级的功能,比如消息验证检测等.官方文档都是有说明的.将faye融入各大框架也非常简单,只要能发起http请求就行了.faye也有iOS和android的客户端,移动端应用也是没有任何问题的.






