<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
  <title>图床on七牛，简单好用的图床插件 - CJ Ting's Blog</title>
  <meta name="author" content="CJ Ting">
  <meta name="description" content="图床on七牛，简单好用的图床插件">
  <meta charset="utf-8" />
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css">

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

  <script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.2/dist/gitalk.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.2/dist/gitalk.css">

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/notyf@3.1.0/notyf.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/notyf@3.1.0/notyf.min.css">

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/zoom-vanilla.js@2.0.6/css/zoom.css">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script>
  MathJax = {
    tex: {
      inlineMath: [["$", "$"]],
    },
  }
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-chtml.js"></script>
  <script type="text/javascript">
    window.PAGE = {
      title: "图床on七牛，简单好用的图床插件",
      section: "web2.0",
    }
  </script>

  <link rel="stylesheet" href="/asset/main.css">
</head>
<body>
  
  <div class="post">
    <header class="post__header" data-cover="http://asset.cjting.cn/007FEWc7ly1g1f3uidzsqj31hc0goafm.jpg">
      <a href="/">
        HOME
      </a>
    </header>

    <div class="post__body">
      <h1 class="post__title">
          图床on七牛，简单好用的图床插件
      </h1>

      <div class="post__meta">
        <div class='date'>
          2017.01.23
        </div>

        <div class="tags">
          
            <span class="tag">图床</span>
          
            <span class="tag">七牛</span>
          
            <span class="tag">chrome</span>
          
        </div>
      </div>

      <div class="post__content">
        <p>注：因为七牛 API 修改，编辑于 2019-03-25T16:20:00。</p>

<p>最近在使用过程中发现 <strong>图床on微博</strong> 出了点问题，响应体的 JSON 解析错误，不用想都知道肯定是微博修改了响应体的数据结构（微博图片上传接口响应体是 html 和 json 混在一起，十分专业）。简单修复了一下，测试的时候却发现，微博的图片上传接口变得不再稳定了，经常 404。看来微博图床是不能用了，正好我早就觉得微博不是个好图床，缺点如下：</p>

<ol>
<li>经常性的要重新登陆，麻烦死了</li>
<li>无法获取到完整的上传图片列表</li>
<li>无法删除上传的图片</li>
<li>服务状态不可控，指不定什么时候接口就不能用了</li>
</ol>

<p>要想对上传的图片拥有完全的控制权，那么图片一定要上传到自己能够控制的地方去。目前国内比较出名的免费存储空间提供商我所知的就是七牛了，简单看了看七牛的文档，做个图床没问题。用户可以创建免费空间，免费空间提供测试域名，限制如下：</p>

<ol>
<li>单 IP 每秒限制请求次数 10 次，大于 10 次禁止 5 秒</li>
<li>单 URL 限速 8 Mbps</li>
</ol>

<p>对于一个图床来说，这个限制完全够用了。</p>

<p>图床其实只需要两个核心接口：</p>

<ol>
<li>图片上传接口</li>
<li>图片获取接口</li>
</ol>

<p>至于图片删除什么的，当然七牛也提供，我个人觉得一个图床工具没必要这么麻烦了。</p>

<p>关于上传，七牛封装有现成的 SDK，比如 <a href="https://developer.qiniu.com/kodo/sdk/1283/javascript">JavaScript SDK</a>，这个 SDK 是基于 <a href="http://www.plupload.com/">Plupload</a> 做的，十分麻烦，提供了一大堆不需要的功能，我需要的就是简单的一个 POST 调用。</p>

<p>在文档中心里的 <a href="https://developer.qiniu.com/kodo/api/1731/api-overview">API 参考</a> 找了一下，找到了 <a href="https://developer.qiniu.com/kodo/api/1312/upload">直传文件 API</a>，接口定义如下。</p>

<pre><code class="language-bash">POST / HTTP/1.1
Host:           &lt;UpHost&gt;
Content-Type:   multipart/form-data; boundary=&lt;frontier&gt;
Content-Length: &lt;multipartContentLength&gt;
--&lt;frontier&gt;
Content-Disposition:       form-data; name=&quot;key&quot;
&lt;resource_key&gt;
--&lt;frontier&gt;
Content-Disposition:       form-data; name=&quot;x:&lt;custom_name&gt;&quot;
&lt;custom_value&gt;
--&lt;frontier&gt;
Content-Disposition:       form-data; name=&quot;token&quot;
&lt;upload_token&gt;
--&lt;frontier&gt;
Content-Disposition:       form-data; name=&quot;crc32&quot;
&lt;crc32&gt;
--&lt;frontier&gt;
Content-Disposition: form-data; name=&quot;x-qn-meta-&lt;metaKey&gt;&quot;
&lt;metaValue&gt;
--&lt;frontier&gt;
Content-Disposition:       form-data; name=&quot;accept&quot;
&lt;acceptContentType&gt;
--&lt;frontier&gt;
Content-Disposition:       form-data; name=&quot;file&quot;; filename=&quot;&lt;fileName&gt;&quot;
Content-Type:              application/octet-stream
Content-Transfer-Encoding: binary
&lt;fileBinaryData&gt;
</code></pre>

<p>一个使用 multipart 传参数的接口，虽然参数很多，但是必传参数只有 <code>upload_token</code>，<code>fileName</code> 以及 <code>fileBinaryData</code>。</p>

<p>关于上传凭证也就是 token 的生成，七牛的文档 <a href="https://developer.qiniu.com/kodo/manual/1208/upload-token">上传凭证</a> 说的很清楚，同时还提供了 <a href="http://jsfiddle.net/gh/get/extjs/4.2/icattlecoder/jsfiddle/tree/master/uptoken">JSFiddle 的在线示例</a>，真是业界良心，千言万语不如代码来的直接。</p>

<p>这里摘录一下最后我的实现。</p>

<pre><code class="language-javascript">function genUpToken(accessKey, secretKey, policy) {
  var policyStr = JSON.stringify(policy)
  var encoded = btoa(utf16to8(policyStr))
  var hash = CryptoJS.HmacSHA1(encoded, secretKey) // npm install crypto-js
  var encodedSign = hash.toString(CryptoJS.enc.Base64)
  var uploadToken = accessKey + &quot;:&quot; + safe64(encodedSign) + &quot;:&quot; + encoded
  return uploadToken
}

function utf16to8(str) {
  var out, i, len, c
  out = &quot;&quot;
  len = str.length
  for(i = 0; i &lt; len; i++) {
    c = str.charCodeAt(i)
    if ((c &gt;= 0x0001) &amp;&amp; (c &lt;= 0x007F)) {
      out += str.charAt(i)
    } else if (c &gt; 0x07FF) {
      out += String.fromCharCode(0xE0 | ((c &gt;&gt; 12) &amp; 0x0F))
      out += String.fromCharCode(0x80 | ((c &gt;&gt;  6) &amp; 0x3F))
      out += String.fromCharCode(0x80 | ((c &gt;&gt;  0) &amp; 0x3F))
    } else {
      out += String.fromCharCode(0xC0 | ((c &gt;&gt;  6) &amp; 0x1F))
      out += String.fromCharCode(0x80 | ((c &gt;&gt;  0) &amp; 0x3F))
    }
  }
  return out
}

function safe64(base64) {
  base64 = base64.replace(/\+/g, &quot;-&quot;)
  base64 = base64.replace(/\//g, &quot;_&quot;)
  return base64
}
</code></pre>

<p>好了，到此上传文件就搞定了。接下来我们看看该怎样获取所有上传的文件。七牛提供了 <a href="https://developer.qiniu.com/kodo/api/1284/list">资源列举</a> 这样的一个接口，听着名字应该就是我们要的，接口定义如下。</p>

<pre><code class="language-bash">GET /list?bucket=&lt;Bucket&gt;&amp;marker=&lt;Marker&gt;&amp;limit=&lt;Limit&gt;&amp;prefix=&lt;UrlEncodedPrefix&gt;&amp;delimiter=&lt;UrlEncodedDelimiter&gt; HTTP/1.1
Host:           rsf.qbox.me
Content-Type:   application/x-www-form-urlencoded
Authorization:  QBox &lt;AccessToken&gt;
</code></pre>

<p>这里又需要一个 token，放在 <code>Authorization</code> Header 里面的，叫做 <a href="https://developer.qiniu.com/kodo/manual/1201/access-token">管理凭证</a>。打开文档看了一下，不算麻烦。代码如下。</p>

<pre><code class="language-javascript">function genManageToken(accessKey, secretKey, pathAndQuery, body) {
  const str = pathAndQuery + &quot;\n&quot; + body
  const hash = CryptoJS.HmacSHA1(str, secretKey)
  const encodedSign = safe64(hash.toString(CryptoJS.enc.Base64))
  return accessKey + &quot;:&quot; + encodedSign
}
</code></pre>

<p>管理凭证生成好以后，将 bucket 参数携带上应该就可以了。最终图片获取的代码如下。</p>

<pre><code class="language-javascript">function fetch() {
  const path = &quot;/list?bucket=&quot; + getItem(&quot;bucket&quot;)
  return axios.post(&quot;http://rsf.qbox.me&quot; + path, null, {
    headers: {
      Authorization: &quot;QBox &quot; + genManageToken(
        getItem(&quot;accessKey&quot;),
        getItem(&quot;secretKey&quot;),
        path,
        &quot;&quot;,
      ),
    },
  })
}
</code></pre>

<p>到这里，核心功能就做好了，剩下的就是 UI 层面的事情，在 <em>图床on微博</em> 的基础上，将历史记录功能优化成了和 Unsplash 一样的三栏显示。最终效果如下所示，关于插件的安装使用仓库 README 中有详细说明，<a href="https://github.com/cj1128/pic-on-qiniu">仓库地址</a>。</p>

<p><img src="http://asset.cjting.cn/007FEWc7ly1g1f3v5j3f4g31810jcnpd.gif" alt="" /></p>
      </div>

      <div id="post__comments">
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/zoom-vanilla.js@2.0.6/dist/zoom-vanilla.min.js"></script>
  <script src="/asset/main.js"></script>

  
  <script>
    (function() {
      var _hmt = _hmt || [];
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4f34ee3c85734c8235badd2b99b092a6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

  
  <div style="display: none">
    <script type="text/javascript" src="https://s23.cnzz.com/z_stat.php?id=1277776204&web_id=1277776204"></script>
  </div>
</body>
</html>
